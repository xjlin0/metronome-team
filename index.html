<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>多人節拍器 MVP</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #beat { font-size: 48px; margin-top: 20px; }
    .highlight { color: red; font-weight: bold; }
    video { width: 300px; height: auto; margin-top: 10px; }
    canvas { display: none; }
    #qrCanvas { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>多人節拍器 MVP</h1>

  <div>
    <button id="becomeLeader">成為 Leader</button>
    <button id="becomeFollower">成為 Follower</button>
  </div>

  <div id="leaderUI" style="display:none;">
    <h2>Leader 模式</h2>
    <label>BPM: <input type="number" id="bpm" value="120" min="30" max="300"></label><br>
    <label>每小節拍數: 
      <select id="beatsPerMeasure">
        <option value="0">無 (全部相同)</option>
        <option value="3">3</option>
        <option value="4" selected>4</option>
      </select>
    </label><br>
    <label>Leader 名稱: <input type="text" id="leaderName"></label><br>
    <button id="start">開始打拍</button>
    <button id="stop">停止</button>
    <div id="qrCanvas"></div>
  </div>

  <div id="followerUI" style="display:none;">
    <h2>Follower 模式</h2>
    <button id="scanBLE">掃描附近的 Leader (BLE)</button>
    <button id="scanQR">用相機掃描 QR Code</button>
    <div id="bleStatus"></div>
    <video id="qrVideo" autoplay></video>
    <canvas id="qrCanvasHidden"></canvas>
  </div>

  <div id="beat"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let isLeader = false;
    let beatInterval;
    let startTime;
    let bpm = 120;
    let beatsPerMeasure = 4;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Leader 預設名稱
    document.getElementById("leaderName").value = "節拍器" + Math.random().toString(36).substring(2,4);

    function playClick(isAccent) {
      let osc = audioCtx.createOscillator();
      let envelope = audioCtx.createGain();
      osc.connect(envelope).connect(audioCtx.destination);
      osc.frequency.value = isAccent ? 1000 : 800;
      envelope.gain.setValueAtTime(1, audioCtx.currentTime);
      envelope.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 0.2);
    }

    function startMetronome() {
      bpm = parseInt(document.getElementById("bpm").value);
      beatsPerMeasure = parseInt(document.getElementById("beatsPerMeasure").value);
      startTime = Date.now();

      clearInterval(beatInterval);
      let intervalMs = 60000 / bpm;
      let beatCount = 0;

      beatInterval = setInterval(() => {
        let isAccent = (beatsPerMeasure > 0) && (beatCount % beatsPerMeasure === 0);
        playClick(isAccent);
        document.getElementById("beat").textContent = isAccent ? "叮" : "噹";
        document.getElementById("beat").className = isAccent ? "highlight" : "";
        beatCount++;
      }, intervalMs);

      // 更新 QR code
      let session = {
        name: document.getElementById("leaderName").value,
        bpm, beatsPerMeasure, startTime
      };
      QRCode.toCanvas(document.createElement("canvas"), JSON.stringify(session), (err, canvas) => {
        let qrDiv = document.getElementById("qrCanvas");
        qrDiv.innerHTML = "";
        qrDiv.appendChild(canvas);
      });

      // TODO: BLE 廣播（需要 PWA + HTTPS）
    }

    function stopMetronome() {
      clearInterval(beatInterval);
      document.getElementById("beat").textContent = "";
    }

    document.getElementById("becomeLeader").onclick = () => {
      isLeader = true;
      document.getElementById("leaderUI").style.display = "block";
      document.getElementById("followerUI").style.display = "none";
    };

    document.getElementById("becomeFollower").onclick = () => {
      isLeader = false;
      document.getElementById("leaderUI").style.display = "none";
      document.getElementById("followerUI").style.display = "block";
    };

    document.getElementById("start").onclick = startMetronome;
    document.getElementById("stop").onclick = stopMetronome;

    // ====== Follower: BLE 掃描 ======
    document.getElementById("scanBLE").onclick = async () => {
      if (!("bluetooth" in navigator) || !navigator.bluetooth.requestLEScan) {
        document.getElementById("bleStatus").innerHTML =
          "此瀏覽器不支援 BLE 掃描，請使用 Android Chrome 並在 <a href='chrome://flags/#experimental-web-platform-features'>chrome://flags/#experimental-web-platform-features</a> 開啟功能";
        return;
      }
      try {
        const scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
        document.getElementById("bleStatus").textContent = "正在掃描附近的 Leader...";
        // TODO: 解析廣播資料
      } catch (e) {
        document.getElementById("bleStatus").textContent = "掃描失敗: " + e;
      }
    };

    // ====== Follower: QR 掃描 ======
    document.getElementById("scanQR").onclick = () => {
      let video = document.getElementById("qrVideo");
      let canvas = document.getElementById("qrCanvasHidden");
      let ctx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              let code = jsQR(imageData.data, canvas.width, canvas.height);
              if (code) {
                let session = JSON.parse(code.data);
                startFollower(session);
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
              }
            }
            requestAnimationFrame(tick);
          }
          tick();
        });
    };

    function startFollower(session) {
      bpm = session.bpm;
      beatsPerMeasure = session.beatsPerMeasure;
      let intervalMs = 60000 / bpm;
      let beatCount = 0;

      clearInterval(beatInterval);
      beatInterval = setInterval(() => {
        let isAccent = (beatsPerMeasure > 0) && (beatCount % beatsPerMeasure === 0);
        playClick(isAccent);
        document.getElementById("beat").textContent = isAccent ? "叮" : "噹";
        document.getElementById("beat").className = isAccent ? "highlight" : "";
        beatCount++;
      }, intervalMs);
    }
  </script>
</body>
</html>

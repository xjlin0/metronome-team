<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Metronome MVP</title>
<style>
  body { text-align:center; font-family:sans-serif; margin:0; padding:20px; }
  canvas { margin:20px auto; display:block; }
  #qr { margin:20px auto; }
  #controls { margin-top:20px; }
  button { margin:5px; padding:10px 20px; font-size:16px; }
</style>
</head>
<body>
<h2>🎵 線上節拍器 MVP</h2>
<canvas id="beat" width="200" height="200"></canvas>

<div id="controls">
  <label>BPM: <input type="range" id="bpm" min="40" max="200" value="100"></label>
  <span id="bpmVal">100</span><br>
  <label>拍/小節: 
    <select id="beatsPerBar">
      <option value="0">無</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
  </label><br>
  <button id="start">開始</button>
  <button id="stop">停止</button>
</div>

<h3>Leader QR Code</h3>
<canvas id="qr"></canvas>

<h3>Follower</h3>
<button id="scanQr">掃描 QR Code 加入</button>
<video id="camera" width="200" autoplay playsinline style="display:none;"></video>
<canvas id="cameraCanvas" width="200" height="200" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let bpm = 100, beatsPerBar = 0, isRunning=false, timer=null, currentBeat=0;
const beatCanvas = document.getElementById("beat");
const ctx = beatCanvas.getContext("2d");

// 自動 resume 音訊 (避免需要多一顆「啟用聲音」)
document.body.addEventListener("click", ()=>{ if(audioCtx.state==="suspended") audioCtx.resume(); }, {once:true});

function drawBeat(active) {
  ctx.clearRect(0,0,200,200);
  ctx.beginPath();
  ctx.arc(100,100, active?80:50,0,2*Math.PI);
  ctx.fillStyle = active? "red":"lightgray";
  ctx.fill();
}

function playClick(accent=false) {
  let osc = audioCtx.createOscillator();
  let gain = audioCtx.createGain();
  osc.frequency.value = accent?1000:700;
  gain.gain.setValueAtTime(0.2,audioCtx.currentTime);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+0.1);
}

function startMetronome() {
  if(isRunning) return;
  isRunning=true;
  currentBeat=0;
  schedule();
}

function stopMetronome() {
  isRunning=false;
  clearInterval(timer);
  drawBeat(false);
}

function schedule() {
  let interval = 60000/bpm;
  timer = setInterval(()=>{
    let accent = (beatsPerBar>0 && currentBeat%beatsPerBar===0);
    playClick(accent);
    drawBeat(true);
    setTimeout(()=>drawBeat(false), interval/2);
    currentBeat++;
  }, interval);
}

// 更新 UI 即時生效
document.getElementById("bpm").oninput=(e)=>{
  bpm = parseInt(e.target.value);
  document.getElementById("bpmVal").textContent=bpm;
  if(isRunning){ stopMetronome(); startMetronome(); updateLeaderInfo(); }
};
document.getElementById("beatsPerBar").onchange=(e)=>{
  beatsPerBar=parseInt(e.target.value);
  if(isRunning){ stopMetronome(); startMetronome(); updateLeaderInfo(); }
};
document.getElementById("start").onclick=()=>{ startMetronome(); updateLeaderInfo(); };
document.getElementById("stop").onclick=()=> stopMetronome();

// Leader QR Code
function updateLeaderInfo(){
  let info = JSON.stringify({ bpm, beatsPerBar });
  QRCode.toCanvas(document.getElementById("qr"), info, {width:200});
}

// Follower 掃描
const video = document.getElementById("camera");
const cameraCanvas=document.getElementById("cameraCanvas");
const camCtx=cameraCanvas.getContext("2d");

document.getElementById("scanQr").onclick=async()=>{
  video.style.display="block"; cameraCanvas.style.display="block";
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  scanLoop();
};

function scanLoop(){
  camCtx.drawImage(video,0,0,200,200);
  let imgData = camCtx.getImageData(0,0,200,200);
  let code = jsQR(imgData.data,imgData.width,imgData.height);
  if(code){
    let data = JSON.parse(code.data);
    bpm=data.bpm; beatsPerBar=data.beatsPerBar;
    document.getElementById("bpm").value=bpm;
    document.getElementById("bpmVal").textContent=bpm;
    document.getElementById("beatsPerBar").value=beatsPerBar;
    stopMetronome(); startMetronome();
    alert("已加入 Leader 節拍設定!");
    video.srcObject.getTracks().forEach(t=>t.stop());
    video.style.display="none"; cameraCanvas.style.display="none";
    return;
  }
  requestAnimationFrame(scanLoop);
}

// 預設值
updateLeaderInfo();
drawBeat(false);
</script>
</body>
</html>

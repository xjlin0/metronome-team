<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>多人同步節拍器 MVP</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background:#222; color:#fff; }
    #controls { margin-top: 20px; }
    #beatCircle {
      width: 150px; height: 150px; margin: 30px auto;
      border-radius: 50%; background: #444;
      transition: background 0.1s ease;
    }
    #qrCanvas, #qrVideo { margin-top: 20px; }
    video { width: 300px; height: auto; border:2px solid #666; }
    button { margin:5px; padding:10px 20px; font-size:16px; }
    input[type=range] { width:200px; }
  </style>
</head>
<body>
  <h1>多人同步節拍器 MVP</h1>

  <!-- 節拍器控制區 -->
  <div id="controls">
    <label>BPM: <input type="range" id="bpm" min="40" max="240" value="120">
      <span id="bpmVal">120</span></label><br>
    <label>每小節拍數:
      <select id="beatsPerMeasure">
        <option value="0">無</option>
        <option value="3">3</option>
        <option value="4" selected>4</option>
      </select>
    </label><br>
    <button id="startBtn">開始</button>
    <button id="stopBtn">停止</button>
  </div>

  <!-- 視覺化圓圈 -->
  <div id="beatCircle"></div>

  <!-- 模式選擇 -->
  <div>
    <button id="beLeader">成為 Leader</button>
    <button id="beFollower">成為 Follower</button>
  </div>

  <!-- Leader UI -->
  <div id="leaderUI" style="display:none;">
    <h3>Leader 模式</h3>
    <div id="qrCanvas"></div>
  </div>

  <!-- Follower UI -->
  <div id="followerUI" style="display:none;">
    <h3>Follower 模式</h3>
    <button id="scanQR">📷 掃描 Leader 的 QR Code</button>
    <button id="cancelScan" style="display:none;">取消</button>
    <video id="qrVideo" autoplay></video>
    <canvas id="qrCanvasHidden"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let bpm = 120;
    let beatsPerMeasure = 4;
    let beatInterval;
    let beatCount = 0;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const circle = document.getElementById("beatCircle");
    const bpmSlider = document.getElementById("bpm");
    const bpmVal = document.getElementById("bpmVal");

    bpmSlider.oninput = () => {
      bpm = parseInt(bpmSlider.value);
      bpmVal.textContent = bpm;
      if (isLeader) updateQRCode();
    };

    document.getElementById("beatsPerMeasure").onchange = (e) => {
      beatsPerMeasure = parseInt(e.target.value);
      if (isLeader) updateQRCode();
    };

    function playClick(isAccent) {
      let osc = audioCtx.createOscillator();
      let env = audioCtx.createGain();
      osc.connect(env).connect(audioCtx.destination);
      osc.frequency.value = isAccent ? 1000 : 800;
      env.gain.setValueAtTime(1, audioCtx.currentTime);
      env.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function startMetronome() {
      clearInterval(beatInterval);
      let intervalMs = 60000 / bpm;
      beatCount = 0;
      beatInterval = setInterval(() => {
        let isAccent = beatsPerMeasure > 0 && (beatCount % beatsPerMeasure === 0);
        playClick(isAccent);
        circle.style.background = isAccent ? "#ff5555" : "#55aaff";
        beatCount++;
      }, intervalMs);
    }

    function stopMetronome() {
      clearInterval(beatInterval);
      circle.style.background = "#444";
    }

    document.getElementById("startBtn").onclick = startMetronome;
    document.getElementById("stopBtn").onclick = stopMetronome;

    // Leader / Follower 切換
    let isLeader = false;
    document.getElementById("beLeader").onclick = () => {
      isLeader = true;
      document.getElementById("leaderUI").style.display = "block";
      updateQRCode();
    };

    document.getElementById("beFollower").onclick = () => {
      isLeader = false;
      document.getElementById("followerUI").style.display = "block";
    };

    // Leader QR code
    function updateQRCode() {
      let session = {
        name: "節拍器" + Math.random().toString(36).substring(2,4),
        bpm, beatsPerMeasure, startTime: Date.now()
      };
      QRCode.toCanvas(JSON.stringify(session), { width: 200 }, (err, canvas) => {
        let qrDiv = document.getElementById("qrCanvas");
        qrDiv.innerHTML = "";
        qrDiv.appendChild(canvas);
      });
    }

    // Follower QR scan
    const scanBtn = document.getElementById("scanQR");
    const cancelBtn = document.getElementById("cancelScan");
    const video = document.getElementById("qrVideo");
    const canvas = document.getElementById("qrCanvasHidden");
    const ctx = canvas.getContext("2d");

    scanBtn.onclick = () => {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          scanBtn.style.display = "none";
          cancelBtn.style.display = "inline-block";
          function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              let code = jsQR(imgData.data, canvas.width, canvas.height);
              if (code) {
                let session = JSON.parse(code.data);
                joinLeader(session);
                stopStream();
              }
            }
            requestAnimationFrame(tick);
          }
          tick();
        });
    };

    cancelBtn.onclick = stopStream;
    function stopStream() {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      scanBtn.style.display = "inline-block";
      cancelBtn.style.display = "none";
    }

    function joinLeader(session) {
      bpm = session.bpm;
      beatsPerMeasure = session.beatsPerMeasure;
      bpmSlider.value = bpm;
      bpmVal.textContent = bpm;
      startMetronome();
    }
  </script>
</body>
</html>

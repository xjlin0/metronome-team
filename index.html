<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Metronome Sync Demo</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #circle { width: 150px; height: 150px; border-radius: 50%; background: lightblue; margin: 50px auto; }
  </style>
</head>
<body>
  <h1>Metronome Sync Demo</h1>
  <div id="circle"></div>
  <p id="tempo">Tempo: --</p>
  <button id="be-leader">Start as Leader</button>
  <button id="join">Join as Follower</button>

  <script>
    let tempo = 100;
    let isLeader = false;
    let peer, channel;
    let interval;

    async function timeSync() {
      let samples = [];
      for (let i=0; i<5; i++) {
        const t0 = Date.now();
        const res = await fetch("/api/timesync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientTime: t0 }),
        });
        const { clientTime, serverTime } = await res.json();
        const t1 = Date.now();
        const rtt = t1 - clientTime;
        const oneWay = rtt/2;
        const offset = (serverTime + oneWay) - t1;
        samples.push(offset);
      }
      samples.sort((a,b)=>a-b);
      return samples[Math.floor(samples.length/2)];
    }

    function startMetronome() {
      const circle = document.getElementById("circle");
      let beat = false;
      if (interval) clearInterval(interval);
      interval = setInterval(()=>{
        beat = !beat;
        circle.style.background = beat ? "lightblue" : "lightgreen";
        new AudioContext().createOscillator().start(); // 簡單 click
      }, 60000/tempo);
    }

    document.getElementById("be-leader").onclick = async ()=>{
      isLeader = true;
      tempo = 120;
      document.getElementById("tempo").innerText = `Tempo: ${tempo}`;
      startMetronome();
      await fetch("/api/leaders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: "demo", tempo, allowChanges: true }),
      });
    };

    document.getElementById("join").onclick = async ()=>{
      const offset = await timeSync();
      console.log("offset", offset);
      const res = await fetch("/api/leaders");
      const leaders = await res.json();
      if (leaders.length) {
        tempo = leaders[0].tempo;
        document.getElementById("tempo").innerText = `Tempo: ${tempo}`;
        startMetronome();
      }
    };
  </script>
</body>
</html>


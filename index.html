<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¤šäººç¯€æ‹å™¨ MVP</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #beat { font-size: 48px; margin-top: 20px; }
    .highlight { color: red; font-weight: bold; }
    video { width: 300px; height: auto; margin-top: 10px; }
    canvas { display: none; }
    #qrCanvas { margin-top: 10px; }
    #leaderList button { display: block; margin: 5px auto; }
  </style>
</head>
<body>
  <h1>å¤šäººç¯€æ‹å™¨ MVP</h1>

  <div>
    <button id="becomeLeader">æˆç‚º Leader</button>
    <button id="becomeFollower">æˆç‚º Follower</button>
  </div>

  <!-- Leader UI -->
  <div id="leaderUI" style="display:none;">
    <h2>Leader æ¨¡å¼</h2>
    <label>BPM: <input type="number" id="bpm" value="120" min="30" max="300"></label><br>
    <label>æ¯å°ç¯€æ‹æ•¸:
      <select id="beatsPerMeasure">
        <option value="0">ç„¡ (å…¨éƒ¨ç›¸åŒ)</option>
        <option value="3">3</option>
        <option value="4" selected>4</option>
      </select>
    </label><br>
    <label>Leader åç¨±: <input type="text" id="leaderName"></label><br>
    <button id="start">é–‹å§‹æ‰“æ‹</button>
    <button id="stop">åœæ­¢</button>
    <div id="qrCanvas"></div>
  </div>

  <!-- Follower UI -->
  <div id="followerUI" style="display:none;">
    <h2>Follower æ¨¡å¼</h2>
    <button id="scanBLE">æƒæé™„è¿‘çš„ Leader (BLE)</button>
    <div id="bleStatus"></div>
    <div id="leaderList"></div>
    <hr>
    <button id="scanQR">ğŸ“· ç”¨ç›¸æ©Ÿæƒæ QR Code</button>
    <video id="qrVideo" autoplay></video>
    <canvas id="qrCanvasHidden"></canvas>
  </div>

  <div id="beat"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let isLeader = false;
    let beatInterval;
    let startTime;
    let bpm = 120;
    let beatsPerMeasure = 4;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0"; // è‡ªè¨‚ UUID

    // Leader é è¨­åç¨±
    document.getElementById("leaderName").value = "ç¯€æ‹å™¨" + Math.random().toString(36).substring(2,4);

    function playClick(isAccent) {
      let osc = audioCtx.createOscillator();
      let envelope = audioCtx.createGain();
      osc.connect(envelope).connect(audioCtx.destination);
      osc.frequency.value = isAccent ? 1000 : 800;
      envelope.gain.setValueAtTime(1, audioCtx.currentTime);
      envelope.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 0.2);
    }

    function startMetronome() {
      bpm = parseInt(document.getElementById("bpm").value);
      beatsPerMeasure = parseInt(document.getElementById("beatsPerMeasure").value);
      startTime = Date.now();

      clearInterval(beatInterval);
      let intervalMs = 60000 / bpm;
      let beatCount = 0;

      beatInterval = setInterval(() => {
        let isAccent = (beatsPerMeasure > 0) && (beatCount % beatsPerMeasure === 0);
        playClick(isAccent);
        document.getElementById("beat").textContent = isAccent ? "å®" : "å™¹";
        document.getElementById("beat").className = isAccent ? "highlight" : "";
        beatCount++;
      }, intervalMs);

      // æ›´æ–° QR code
      let session = {
        name: document.getElementById("leaderName").value,
        bpm, beatsPerMeasure, startTime
      };
      QRCode.toCanvas(document.createElement("canvas"), JSON.stringify(session), (err, canvas) => {
        let qrDiv = document.getElementById("qrCanvas");
        qrDiv.innerHTML = "";
        qrDiv.appendChild(canvas);
      });

      // å˜—è©¦ BLE å»£æ’­
      advertiseBLE(session);
    }

    function stopMetronome() {
      clearInterval(beatInterval);
      document.getElementById("beat").textContent = "";
    }

    document.getElementById("becomeLeader").onclick = () => {
      isLeader = true;
      document.getElementById("leaderUI").style.display = "block";
      document.getElementById("followerUI").style.display = "none";
    };

    document.getElementById("becomeFollower").onclick = () => {
      isLeader = false;
      document.getElementById("leaderUI").style.display = "none";
      document.getElementById("followerUI").style.display = "block";
    };

    document.getElementById("start").onclick = startMetronome;
    document.getElementById("stop").onclick = stopMetronome;

    // ====== Leader: BLE å»£æ’­ (éƒ¨åˆ†ç€è¦½å™¨éœ€é–‹ flag) ======
    async function advertiseBLE(session) {
      if (!navigator.bluetooth || !navigator.bluetooth.requestDevice) {
        console.log("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ BLE å»£æ’­");
        return;
      }
      try {
        // âš ï¸ Web Bluetooth é‚„ä¸æ”¯æŒæ­£å¼å»£æ’­ APIï¼Œåªèƒ½é€é GATT æœå‹™é–“æ¥æ–¹å¼
        const advData = new TextEncoder().encode(JSON.stringify(session));
        const adv = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });
        console.log("å·²é–‹å§‹ BLE å»£æ’­ (æ¨¡æ“¬):", advData);
      } catch (e) {
        console.error("BLE å»£æ’­å¤±æ•—:", e);
      }
    }

    // ====== Follower: BLE æƒæ ======
    document.getElementById("scanBLE").onclick = async () => {
      if (!("bluetooth" in navigator) || !navigator.bluetooth.requestLEScan) {
        document.getElementById("bleStatus").innerHTML =
          "æ­¤ç€è¦½å™¨ä¸æ”¯æ´ BLE æƒæã€‚è«‹æ”¹ç”¨ QR Codeï¼Œæˆ–åœ¨ Android Chrome æ‰“é–‹ ğŸ‘‰ " +
          "<a href='chrome://flags/#enable-experimental-web-platform-features'>chrome://flags/#enable-experimental-web-platform-features</a>";
        return;
      }
      try {
        const scan = await navigator.bluetooth.requestLEScan({ acceptAllAdvertisements: true });
        document.getElementById("bleStatus").textContent = "æ­£åœ¨æƒæé™„è¿‘çš„ Leader...";
        navigator.bluetooth.addEventListener('advertisementreceived', event => {
          const advText = new TextDecoder().decode(event.manufacturerData.get(0xFFFF));
          try {
            const session = JSON.parse(advText);
            let btn = document.createElement("button");
            btn.textContent = `${session.name} (BPM ${session.bpm})`;
            btn.onclick = () => startFollower(session);
            document.getElementById("leaderList").appendChild(btn);
          } catch {}
        });
      } catch (e) {
        document.getElementById("bleStatus").textContent = "æƒæå¤±æ•—: " + e;
      }
    };

    // ====== Follower: QR æƒæ ======
    document.getElementById("scanQR").onclick = () => {
      let video = document.getElementById("qrVideo");
      let canvas = document.getElementById("qrCanvasHidden");
      let ctx = canvas.getContext("2d");

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              let code = jsQR(imageData.data, canvas.width, canvas.height);
              if (code) {
                let session = JSON.parse(code.data);
                startFollower(session);
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
              }
            }
            requestAnimationFrame(tick);
          }
          tick();
        });
    };

    function startFollower(session) {
      bpm = session.bpm;
      beatsPerMeasure = session.beatsPerMeasure;
      let intervalMs = 60000 / bpm;
      let beatCount = 0;

      clearInterval(beatInterval);
      beatInterval = setInterval(() => {
        let isAccent = (beatsPerMeasure > 0) && (beatCount % beatsPerMeasure === 0);
        playClick(isAccent);
        document.getElementById("beat").textContent = isAccent ? "å®" : "å™¹";
        document.getElementById("beat").className = isAccent ? "highlight" : "";
        beatCount++;
      }, intervalMs);
    }
  </script>
</body>
</html>
